# 2η άσκηση

Σκοπός της άσκησης είναι να εξασκηθείς στην χρήση του HTTPS.
Γι' αυτή την άσκηση θα χρειαστείς ένα domain name που έχεις στην κατοχή σου
και είναι ρυθμισμένο να κάνει resolve σε έναν server στον οποίο έχεις root πρόσβαση.

Αν δεν έχεις κάποιο domain, μπορείς να αποκτήσεις ένα από διάφορους παρόχους, για παράδειγμα από το
[Namecheap](https://www.namecheap.com/) απ' όπου μπορείς να πληρώσεις και με bitcoins.

Αν δεν έχεις κάποιον server μπορείς να αποκτήσεις έναν από διάφορους παρόχους. Σήμερα οι servers στο
'cloud' είναι αρκετά δημοφιλείς και μπορείς να αποκτήσεις έναν δωρεάν για κάποιο χρονικό διάστημα. Για παράδειγμα
μπορείς να φτιάξεις λογαριασμό στην [Digital Oceal](https://www.digitalocean.com/) και να χρησιμοποιήσεις το κουπόνι 
**OMGSSD10** για πιστωθούν δωρεάν 10$ στον λογαριασμό σου.

## Απόκτηση πιστοποιητικού
Για να ρυθμίσουμε έναν server με HTTPS πρέπει να έχουμε στην κατοχή μας ένα ζεύγος κλειδιών το οποίο να είναι υπογεγραμμένο
από μία έμπιστη αρχή. Ο τρόπος που γίνεται αυτό είναι δημιουργώντας ένα μη υπογεγραμμένο ζεύγος στον server που θέλουμε
να ρυθμίσουμε και στη συνέχεια στέλνοντας μία αίτηση για υπογραφή στην έμπιστη αρχή.

Η έμπιστη αρχή θα υπογράψει το κλειδί μας αν και μόνο αν παρουσιάσουμε κάποια αποδεικτικά. Για το είδος πιστοποιητικού
που θα χρησιμοποιήσουμε αρκεί να αποδείξουμε ότι είμαστε οι κάτοχοι του domain. Αυτό γίνεται αποδεικνύοντας ότι μπορούμε
να λάβουμε ένα email με έναν κωδικό στη διεύθυνση email που έχει δηλωθεί ως η διεύθυνση κατόχου όταν αγοράσαμε το domain.

Η έμπιστη αρχή που θα χρησιμοποιήσουμε είναι η StartSSL. Προσφέρουν βασικά πιστοποιητικά δωρεάν, αλλά θα χρεώσουν για άλλους τύπους, όπως πιστοποιητικά wildcard.
Γι' αυτή την άσκηση θα χρειαστείς μόνο ένα δωρεάν πιστοποιητικό.

### Δημιουργία ενός δημόσιου/ιδιωτικού ζεύγους κλειδιού

Ένα ζεύγος κλειδιού μπορεί να δημιουργηθεί με το OpenSSL. Τρέξε τώρα την παρακάτω εντολή για να φτιάξεις ένα νέο ζεύγος:

    openssl req -new -newkey rsa:2048 -keyout example.com.key -nodes -out example.com.csr

Στη θέση του ονόματος example.com βάλε το δικό σου domain. Αυτή η εντολή θα σε προτρέψει για το όνομα της χώρας, της πολιτείας κλπ. *Όλα αυτά μπορούν να αγνοηθούν*. Απλά πάτα enter για να αποδεχθείς τις προεπιλογές επειδή το StartSSL δεν χρησιμοποιεί αυτές τις πληροφορίες.

Η μόνη πληροφορία που ίσως θέλεις να δώσεις είναι ένας κωδικός για να προστατέψεις το ιδιωτικό κλειδί σου. Έχε στον νου σου ότι ο webserver χρειάζεται το ιδιωτικό κλειδί οπότε, αν χρησιμοποιήσεις κωδικό, θα πρέπει να τον πληκτρολογείς κάθε φορά που επανεκκινείς τον webserver.

Το αρχείο example.com.key είναι το ιδιωτικό κλειδί σου και πρέπει να το φυλάξεις κάπου καλά. Αν χάσεις αυτό το αρχείο (για παράδειγμα λόγω προβλήματος στον server) θα πρέπει να ξανακάνεις όλη τη διαδικασία από την αρχή.

Το αρχείο example.com.csr είναι ένα αρχείο τύπου "Certificate Signing Request". Περιέχει όλες τις απαραίτητες πληροφορίες, μεταξύ αλλών και το δημόσιο κλειδί μας, που χρειάζεται η έμπιστη αρχή για να μας υπογράψει. Σε επόμενο βήμα θα στείλουμε αυτό το αρχείο στην StartSSL.

Παρατήρησε ότι αυτό το κλειδί είναι ένα κλειδί που πιστοποιεί την ταυτότητα του domain σου και διαφέρει από το GPG κλειδί σου που χρησιμοποιείς για να πιστοποιήσεις τη δική σου ταυτότητα.

Τώρα που έχουμε ένα κλειδί, μπορούμε να πάρουμε ένα πιστοποιητικό υπογεγραμμένο από την Έμπιστη Αρχή.


### StartSSL

Το StartSSL είναι δωρεάν, αλλά δεν είναι η καλύτερα σχεδιασμένη ιστοσελίδα στον κόσμο. Παρακάτω είναι μία σειρά από screenshots που θα σε καθοδηγήσουν. Δεν υπάρχει ένα screenshot για απολύτως όλα τα βήματα οπότε κάνε την προφανή ενέργεια σε κάθε βήμα. Αν πρέπει να κάνεις κλικ σε κάτι τότε το screenshot ίσως έχει ένα κόκκινο δαχτυλίδι γύρω από τον στόχο.

Αρχικά, *χρησιμοποίησε Firefox*. Σοβαρά.

Πήγαινε στο [StartSSL](https://startssl.com) (θα πρέπει να έχει ένα πιστοποιητικό τύπου EV). Στην αρχική σελίδα, κάνε κλικ στο "Control Panel" πάνω δεξιά για να ξεκινήσεις.

![StartSSL frontpage](/exercises/ssl/01.jpg)

Υποθέτουμε ότι δεν έχεις ξαναχρησιμοποιήσει το StartSSL στο παρελθόν οπότε πρέπει να κάνεις εγγραφή:

![StartSSL signup page](/exercises/ssl/02.jpg)

Γράψε τα στοιχεία σου:

![StartSSL account page](/exercises/ssl/03.jpg)

Θα πρέπει να επιβεβαιώσεις το email σου εισάγοντας την μαγική τιμή που θα σου σταλεί:

![StartSSL account page](/exercises/ssl/04.jpg)

Το StartSSL δεν χρησιμοποιεί κωδικούς για τους λογαριασμούς, χρησιμοποιεί client-side πιστοποιητικά. Πρέπει να δημιουργήσεις ένα και να το εγκαταστήσεις στον browser σου:

![StartSSL account page](/exercises/ssl/05.jpg)

![StartSSL εγκατάσταση client-side πιστοποιητικού](/exercises/ssl/06.jpg)

Το πιστοποιητικό αυτό δεν θα χρησιμοποιηθεί για την πιστοποίηση του domain name σου, αλλά μόνο για την πρόσβαση στο λογαριασμό που μόλις έφτιαξες ως χρήστης της σελίδας startssl.

![StartSSL control panel page](/exercises/ssl/07.jpg)

Αφού τελειώσεις με το άνοιγμα του λογαριασμού σου, θα βρεθείς στο "Control Panel" σου. Αρχικά πρέπει να αποδείξεις ότι έχεις τον έλεγχο του ιστότοπου για τον οποίο θες να εκδόσεις ένα πιστοποιητικό. Για τα δωρεάν πιστοποιητικά, αυτό σημαίνει να μπορείς να λάβεις email για κάποια συγκεκριμένα usernames.

![StartSSL control panel page](/exercises/ssl/08.jpg)

Επικυρώνεις ένα όνομα ιστοτόπου, οπότε επίλεξε "Domain Name Validation".

![StartSSL control panel page](/exercises/ssl/09.jpg)
![StartSSL control panel page](/exercises/ssl/10.jpg)

Πρέπει να μπορείς να λάβεις email για ένα από τα συγκεκριμένα usernames ή στο email που δήλωσες όταν αγόρασες το domain. Αν είχες επιλέξει να πάρεις whois guart (συνήθως το προσφέρουν δωρεάν για κάποιο καιρό) θα δεις μία περίεργη διεύθυνση που όμως είναι alias για την πραγματική σου:

![StartSSL control panel page](/exercises/ssl/11.jpg)

Περίμενε για το email και γράψε τον κωδικό που περιέχει στο πλαίσιο κειμένου.

![StartSSL control panel page](/exercises/ssl/12.jpg)

Αφού αποδείξεις ότι είσαι ο ιδιοκτήτης του ιστότοπου, επίλεξε 'Finish' στο 'Validation wizard' και μπες στο 'Certificate wizard'.

![StartSSL control panel page](/exercises/ssl/13.jpg)
![StartSSL control panel page](/exercises/ssl/14.jpg)

Θέλεις ένα HTTPS πιστοποιητικό, οπότε επίλεξε "Web Server SSL/TLS Certificate".

![StartSSL control panel page](/exercises/ssl/15.jpg)

Αυτό το βήμα είναι σημαντικό. *Παράκαμψε την δημιουργία ιδιωτικού κλειδιού.* Έχεις ήδη φτιάξει το ιδιωτικό κλειδί σου στην αρχή του οδηγού. Θα δώσουμε στο StartSSL το δημόσιο κλειδί μας για να το υπογράψει και το ιδιωτικό κλειδί δεν θα πρέπει να φύγει ποτέ από τον έλεγχό σου. Δεν θέλεις το StartSSL να έχει πρόσβαση στο ιδιωτικό σου κλειδί!

![StartSSL control panel page](/exercises/ssl/16.jpg)

Η εντολή `openssl` που έτρεξες στην αρχή δημιούργησε δύο αρχεία. Το ένα από αυτά ήταν ένα αρχείο CSR. Πρέπει να ανοίξεις αυτό το αρχείο και να επικολλήσεις τα περιεχόμενά του μέσα στο πλαίσιο κειμένου. Τα αρχεία CSR είναι απλά αρχεία κειμένου οπότε σχεδόν οτιδήποτε θα πρέπει να μπορεί να το ανοίξει (π.χ. vim ή notepad). Παρατήρησε ότι το CSR περιέχει μόνο το δημόσιο και όχι το ιδιωτικό σου κλειδί, οπότε δεν είναι κάτι κρυφό.

![StartSSL control panel page](/exercises/ssl/17.jpg)
![StartSSL control panel page](/exercises/ssl/18.jpg)

Επίλεξε τον ιστότοπο που μόλις επικύρωσες.

![StartSSL control panel page](/exercises/ssl/19.jpg)

Σου συνιστούμε ιδιαίτερα να προσθέσεις το subdomain `www` στο πιστοποιητικό.

![StartSSL control panel page](/exercises/ssl/20.jpg)

Έλεγξε ότι όλα τα στοιχεία είναι σωστά και πάτα "Continue".
![StartSSL control panel page](/exercises/ssl/21.jpg)

Πιθανά το πιστοποιητικό σου να μη γίνει άμεσα διαθέσιμο. Σε αυτή την περίπτωση θα δεις αυτό το μήνυμα. Θα ειδοποιηθείς με email όταν το πιστοποιητικό σου είναι έτοιμο. Συνήθως παίρνει λιγότερο από μισή ώρα.

![StartSSL control panel page](/exercises/ssl/22.jpg)

Όταν ειδοποιηθείς ότι το πιστοποιητικό σου είναι έτοιμο πήγαινε στο "Tool box" από την αρχική σελίδα και επίλεξε "Retrieve certificate" από το μενού.
![StartSSL control panel page](/exercises/ssl/23.jpg)
![StartSSL control panel page](/exercises/ssl/24.jpg)

Διάλεξε το domain name για το οποίο θες το πιστοποιητικό.
![StartSSL control panel page](/exercises/ssl/25.jpg)

Έχουμε σχεδόν τελειώσει! Αυτό είναι το υπογεγραμμένο σου πιστοποιητικό. Αποθήκευσέ το σε κάποια ασφαλή τοποθεσία. Δεν είναι κρυφό, αλλά δεν θες να το χάσεις! Περιέχει το δημόσιο κλειδί που αντιστοιχεί στο domain name σου υπογεγραμμένο από την έμπιστη αρχή. Σε κάθε περίπτωση, το ιδιωτικό κλειδί που αντιστοιχεί στο domain σου δεν έχει φύγει ποτέ από τον υπολογιστή σου και από τον web server σου.

![StartSSL control panel page](/exercises/ssl/26.jpg)

## Ρύθμιση server

Τώρα που αποκτήσαμε το υπογεγραμμένο πιστοποιητικό μας μένει μόνο να το εγκαταστήσουμε στον webserver. Σε αυτό τον οδηγό θα δούμε πως μπορούμε να ρυθμίσουμε 2 από τους πιο δημοφιλής http server, τον nginx και τον apache.

## Nginx

### Εγκατάσταση πιστοποιητικού

Δημιούργησε τον φάκελο /etc/nginx/certs στον server σου και μετάφερε σε αυτόν τον φάκελο το αρχείο example.com.key που έφτιαξες στην αρχή του οδηγού. Αυτό είναι το ιδιωτικό κλειδί που αντιστοιχεί στο domain name σου.

    mkdir /etc/nginx/certs
    cp example.com.key /etc/nginx/certs

Αυτό θα πρέπει να το κάνεις ως χρήστης root και το αρχείο αυτό θα πρέπει να είναι αναγνώσιμο μόνο από τον root χρήστη. Αν κάποιος τρίτος αποκτήσει πρόσβαση σε αυτό το αρχείο θα μπορεί να εκτελέσει επιθέσεις MITM και να προσποιηθεί ότι είναι το site σου.

Τώρα φτιάξε το αρχείο `/etc/nginx/certs/example.com.crt` και βάλε μέσα το πιστοποιητικό που σου εμφάνισε το StartSSL στο τελευταίο βήμα. Αφού το κάνεις αυτό θα πρέπει να κάνεις append στο αρχείο τα ενδιάμεσα πιστοποιητικά του StartSSL.

	curl https://www.startssl.com/certs/sub.class1.server.ca.pem >> /etc/nginx/certs/example.com.crt

Αυτό το αρχείο πλέον περιέχει, εκτός από το δικό σου υπογεγραμμένο πιστοποιητικό, και ένα πιστοποιητικό που εγγυάται την ταυτότητα και την εμπιστοσύνη της έμπιστης αρχής StartSSL και είναι υπογεγραμμένο από μία τρίτη έμπιστη αρχή. Η εμπιστοσύνη για την αρχική έμπιστη αρχή ενυπάρχει προεγκατεστημένη στο λειτουργικό σύστημα ή στους browsers όλων των χρηστών.

Προτείνουμε τη χρήση ενός nginx configuration το οποίο επιτρέπει μόνο κρυπτοσυστήματα με perfect forward secrecy, αναβαθμίζει όλες τις HTTP συνδέσεις σε HTTPS και επίσης στέλνει το HSTS header. Το configuration αυτό έχει δοκιμαστεί σε server ο οποίος τρέχει ArchLinux. Πιθανά να χρειαστεί κάποιες μικροαλλαγές για να παίξει με διαφορετικές διανομές. Εδώ είναι το αρχείο μαζί με την υπογραφή μου για να επιβεβαιώσετε ότι έχετε το σωστό αρχείο.

[nginx.conf](/exercises/ssl/nginx.conf) - [(gpg signature)](/exercises/ssl/nginx.conf.sig)

Θα χρειαστεί να επανεκκινήσεις τον nginx.

## Apache

### Εγκατάσταση πιστοποιητικού

Δημιούργησε τον φάκελο /etc/apache2/certs στον server σου και μετάφερε σε αυτόν τον φάκελο τα αρχεία example.com.key και example.com.crt που έφτιαξες στην αρχή του οδηγού. Αυτό είναι το ιδιωτικό κλειδί που αντιστοιχεί στο domain name σου. Ο φάκελος /etc/apache2 είναι ο φάκελος στον οποίο βρίσκεται το configuration του apache σου και ενδέχεται να διαφέρει από server σε server (π.χ. μπορεί να βρίσκεται στο /etc/httpd).

    mkdir /etc/apache2/certs
    cp example.com.key /etc/apache2/certs

Αυτό θα πρέπει να το κάνεις ως χρήστης root και το αρχείο αυτό θα πρέπει να είναι αναγνώσιμο μόνο από τον root χρήστη. Αν κάποιος τρίτος αποκτήσει πρόσβαση σε αυτό το αρχείο θα μπορεί να εκτελέσει επιθέσεις MITM και να προσποιηθεί ότι είναι το site σου.

Τώρα φτιάξε το αρχείο `/etc/apache2/certs/example.com.crt` και βάλε μέσα το πιστοποιητικό που σου εμφάνισε το StartSSL στο τελευταίο βήμα.

Στη συνέχεια, κατέβασε τα ενδιάμεσα πιστοποιητικά για την StartSSL και τοποθέτησέ τα σε ένα ξεχωριστό αρχείο:

    cd /etc/apache2/certs
	wget https://www.startssl.com/certs/sub.class1.server.ca.pem

Αυτό θα δημιουργήσει το αρχείο /etc/apache2/certs/sub.class1.server.ca.pem που περιέχει ένα πιστοποιητικό το οποίο εγγυάται την ταυτότητα και την εμπιστοσύνη της έμπιστης αρχής StartSSL και είναι υπογεγραμμένο από μία τρίτη έμπιστη αρχή. Η εμπιστοσύνη για την αρχική έμπιστη αρχή ενυπάρχει προεγκατεστημένη στο λειτουργικό σύστημα ή στους browsers όλων των χρηστών.

Επίσης, κατέβασε το αρχείο ca.pem και τοποθέτησέ το σε ένα ξεχωριστό αρχείο:

    cd /etc/apache/certs
    wget https://www.startssl.com/certs/ca.pem

Πλέον μπορείς να ρυθμίσεις τον apache σου αλλάζοντας το αρχείο που αντιστοιχεί στο VirtualHost configuration για το website σου. Σε Ubuntu και Debian-based συστήματα, αυτά τα αρχεία βρίσκονται στο /etc/apache2/sites-enabled. Για παράδειγμα το αρχείο ρυθμίσεων που αφορά το domain σου μπορεί να είναι στο /etc/apache2/sites-enabled/example.com. Θα πρέπει να επεξεργαστείς το αρχείο που αφορά τη σελίδα στην οποία θες να ενεργοποιήσεις το HTTPS.

Παρακάτω βρίσκεται ένα παράδειγμα configuration file:

[example.com](/exercises/ssl/example.com)

Στο συγκεκριμένο configuration, επιτρέπεται τόσο η πρόσβαση μέσω HTTP, όσο και μέσω HTTPS. Προτείνουμε η HTTP έκδοση της σελίδας σου να κάνει redirect στην HTTPS έκδοση. Θα χρειαστεί να αλλάξεις το configuration file ώστε να ανταποκρίνεται στη σελίδα σου: Θα πρέπει να αλλάξεις το example.com ώστε να είναι το domain name σου, τους φακέλους ώστε να ανταποκρίνονται στο htdocs σου, και τα ονόματα των αρχείων που αφορούν τα πιστοποιητικά.

Οι σημαντικές ρυθμίσεις είναι εκείνες που ξεκινούν με το πρόθεμα SSL. Αφορούν την ενεργοποίηση του SSL (`SSLEngine on`), και την επιλογή των διαφόρων αρχείων που περιέχουν κλειδιά και πιστοποιητικά: `SSLCertificateFile`, `SSLCertificateChainFile`, `SSLCertificateKeyFile`, `SSLCACertificateFile`.

Τέλος, αν αυτό είναι το πρώτο website για το οποίο ενεργοποιείς το SSL στο συγκεκριμένο server, θα πρέπει να ρυθμίσεις τον Apache σου ώστε να ακούει και στην πόρτα 443, δηλαδή την πόρτα που αφορά το HTTPS. Αυτό γίνεται αλλάζοντας το αρχείο που περιέχει ήδη την εντολή `Listen 80` στο configuration σου. Σε Debian συστήματα, το αρχείο που πρέπει να αλλάξεις είναι το /etc/apache2/ports.conf, αλλά μπορεί να διαφέρει από σύστημα σε σύστημα. Παρακάτω βρίσκεται ένα παράδειγμα ports.conf με ενεργοποιημένο το SSL:

[ports.conf](/exercises/ssl/ports.conf)

Πιθανώς να μπορείς να χρησιμοποιήσεις αυτό το αρχείο αυτούσιο.

Αφότου κάνεις όλες αυτές τις αλλαγές, θα χρειαστεί να επανεκκινήσεις τον apache.

## Επιβεβαίωση ρυθμίσεων

Επισκέψου το domain σου με https και φρόντισε να ισχύουν τα ακόλουθα:
* Υπάρχει ένα λουκέτο στη μπάρα URL που επιβεβαιώνει ότι η σύνδεση είναι ασφαλής
* Το πρωτόκολλο είναι https
* Δεν εμφανίζονται warnings ή άλλα μηνύματα σφαλμάτων που αφορούν την ασφάλεια του TLS
* Όταν επισκέπτεσαι τη σελίδα μέσω http, γίνεται redirect σε https

Αφού ακολουθήσεις όλα τα βήματα και ρυθμίσεις τον web server σου θα πρέπει να έχεις ένα ασφαλές και κρυπτογραφημένο site!

Θα θέλαμε ο παραπάνω οδηγός να χρησιμοποιείται ως αναφορά για τη διασφάλιση του Ελληνικού web. Αν βρεις κάποιο πρόβλημα ή κάποια από τις οδηγίες είναι λάθος, παρακαλούμε επικοινώνησε μαζί μας για να το διορθώσουμε.
