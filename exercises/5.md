# 5η άσκηση

Επιμέλεια: [Δημήτρης Καρακώστας](https://github.com/dimkarakostas)

Σκοπός της άσκησης είναι να εξοικειωθείς με τη χρήση του Tor και να δημιουργήσεις ένα δικό σου hidden service. Για αυτή την άσκηση θα χρειαστείς έναν server, στον οποίο θα στήσεις το hidden service.

## Γενικά

To Tor είναι ένα λογισμικό το οποίο σου παρέχει προστασία κατά την περιήγηση στο διαδίκτυο. Κατά τη σύνδεση στο Tor, η επικοινωνία σου με το διαδίκτυο γίνεται μέσω ενός δικτύου κόμβων, τους οποίους διαχειρίζονται εθελοντές χρήστες σε όλο τον κόσμο. Με αυτό τον τρόπο σου παρέχει προστασία, αφενός απέναντι σε κακόβουλους χρήστες που προσπαθούν να μάθουν τη συμπεριφορά σου στο διαδίκτυο, αφετέρου απέναντι σε ιστοσελίδες οι οποίες προσπαθούν να μάθουν τη φυσική σου τοποθεσία. Περισσότερα για το Tor μπορείς να μάθεις στη σελίδα του [Tor Project](https://www.torproject.org/about/overview.html.en).

Το Tor δίνει επιπλέον τη δυνατότητα στους χρήστες, μέσω των hidden services, να προσφέρουν online υπηρεσίες, ενώ παράλληλα η θέση τους παραμένει ανώνυμη. Ένα hidden service μπορεί να προσπελαστεί χρησιμοποιώντας μόνο τον Tor Browser, όπου πληκτρολογώντας μια διεύθυνση της μορφής XYZ.onion (όπου ΧΥΖ μια 16-ψήφια συμβολοσειρά) μπορείς να χρησιμοποιήσεις την αντίστοιχη υπηρεσία. Περισσότερες πληροφορίες στην υλοποίηση του πρωτοκόλλου Hidden Service μπορείς να δεις [εδώ](https://www.torproject.org/docs/hidden-services.html.en).

## Εγκατάσταση

### Server

Αρχικά θα χρειαστείς ένα μηχάνημα στο οποίο να εγκαταστήσεις τον server. Για τους σκοπούς της άσκησης χρησιμοποιήσαμε Ubuntu 14.04, ωστόσο και με άλλο λειτουργικό σύστημα τα βήματα είναι αντίστοιχα. Μια καλή λύση είναι η χρήση του LAMP (Linux-Apache-MySQL-PHP), το οποίο μπορείς να εγκαταστήσεις με την εντολή (**σημείωση**: το caret (^) δεν είναι ορθογραφικό λάθος, αλλά χρειάζεται για την εκτέλεση της εντολής):

    sudo apt-get install lamp-server^
	
Πλέον στο μηχάνημά σου είναι εγκατεστημένος ο Apache server, όπου αν επισκεφτείς τη διεύθυνση IP σου (ή το localhost αν είσαι μέσα στο μηχάνημα) θα πρέπει να μπορείς να δεις την αρχική σελίδα του. Στη διεύθυνση */var/www/html* μπορείς να δεις τα αρχεία των sites σου. Μπορείς να δοκιμάσεις να φτιάξεις ένα δικό σου html αρχείο στη διεύθυνση αυτή, ώστε να δεις αν μπορείς να το προσπελάσεις μέσω του browser για να σιγουρευτείς πως δουλεύει ο server.

### Tor

Για να χρησιμοποιήσεις το δίκτυο Tor, χρειάζεται να έχεις εγκατεστημένο το αντίστοιχο πακέτο. Στην περίπτωσή μας είμαστε σε Ubuntu, οπότε θα χρειαστεί πρώτα να προσθέσουμε το αντίστοιχο repository (αν βρίσκεσαι σε Debian μπορείς να παραβλέψεις αυτό το βήμα). Συγκεκριμένα, στο αρχείο /etc/apt/sources.list προσθέτουμε τη γραμμή:

    deb     http://deb.torproject.org/torproject.org <DISTRIBUTION> main

όπου, στην περίπτωσή μας, το distribution είναι trusty. Στη συνέχεια εκτελούμε τις εντολές:

    gpg --keyserver keys.gnupg.net --recv 886DDD89
    gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | sudo apt-key add -
    sudo apt-get update
    sudo apt-get install deb.torproject.org-keyring
	
Για να εγκαταστήσουμε τώρα το Tor εκτελούμε την εντολή:

    sudo apt-get install tor
	
### Hidden service

Για να δημιουργήσεις το hidden service, θα πρέπει να τροποποιήσεις το αρχείο torrc. Στην περίπτωσή μας αυτό βρίσκεται στο φάκελο /etc/tor/. Συγκεκριμένα, αναζήτησε τη γραμμή:

    ############### This section is just for location-hidden services ###

Σε εκείνο το σημείο του αρχείου βρίσκονται οι πληροφορίες που αφορούν τη δημιουργία hidden service. Ειδικότερα, σε ενδιαφέρουν οι παράμετροι HiddenServiceDir και HiddenServicePort.

Η HiddenServiceDir είναι η μεταβλητή για το directory στο οποίο το Tor θα αποθηκεύσει τις πληροφορίες για το hidden service. Ο χρήστης που τρέχει το Tor θα πρέπει να έχει read/write permissions για το συγκεκριμένο directory, οπότε είναι μια καλή ιδέα να επιλέξεις το μονοπάτι */var/lib/tor/*.

**Προσοχή**

Ο φάκελος αυτός θα περιέχει ευαίσθητες πληροφορίες για το hidden service, οπότε είναι σημαντικό να μη χρησιμοποιείται από άλλες υπηρεσίες.

Η HiddenServicePort αντιστοιχεί μια IP (στην περίπτωσή μας 127.0.0.1) και μια θύρα (:80) σε μια εικονική θύρα (στην περίπτωσή μας το πρώτο όρισμα, 80). Ένας Web Server συνήθως είναι διαθέσιμος στη θύρα 80 του μηχανήματος στο οποίο είναι εγκατεστημένος (αντίστοιχα ένας FTP Server στη θύρα 21 κλπ), χωρίς ωστόσο αυτό να είναι υποχρεωτικό, καθώς μπορεί να οριστεί οποιαδήποτε άλλη (αχρησιμοποίητη) θύρα. Συνεπώς, μπορείς να ορίσεις τη συγκεκριμένη μεταβλητή, ώστε οι συνδέσεις προς την IP και την πραγματική θύρα να προωθούνται προς την εικονική θύρα και όσοι συνδέονται με την υπηρεσία να νομίζουν πως χρησιμοποιούν την εικονική αντί της πραγματικής.

Τελικά, θα προσθέσεις, ή θα κάνεις uncomment και θα τροποποιήσεις κατάλληλα, τις παρακάτω γραμμές:

    HiddenServiceDir /var/lib/tor/hidden_service/
    HiddenServicePort 80 127.0.0.1:80
	
Για να ολοκληρωθούν οι αλλάγές θα πρέπει να κάνεις επανεκκίνηση του Tor με την εντολή:

    sudo service tor restart
	
## Tor Hidden Service

Αν το restart του Tor ολοκληρώθηκε επιτυχώς (έλεγξε το αρχείο */var/log/tor/log* για τις αντίστοιχες καταγραφές), θα πρέπει να έχουν δημιουργηθεί δύο αρχεία στο directory που όρισες στη μεταβλητη HiddenServiceDir (στην περίπτωσή μας */var/lib/tor/hidden_service/*).

Το πρώτο είναι το private_key, το οποίο, μαζί με το αντίστοιχο public key, δημιουργήθηκε από το Tor και αφορά στο hidden service σου. Για το κλειδί αυτό είναι καλό να έχεις backup, καθώς μπορείς να το χρησιμοποιήσεις για να μεταφέρεις το hidden service σου σε άλλο μηχάνημα. Μπορείς να το δεις με την εντολή:

    sudo cat /var/lib/tor/hidden_service/private_key

**Προσοχή**

Το private_key δεν πρέπει **σε καμία περίπτωση** να το μοιραστείς με άλλους, καθώς θα μπορούν να το χρησιμοποιήσουν ώστε να υποδυθούν το hidden service σου.

Το δεύτερο αρχείο είναι το hostname, το οποίο μπορείς να δεις με την εντολή:

    sudo cat /var/lib/tor/hidden_service/hostname
	
Η έξοδός του θα είναι της μορφής **5azo3roqn4opexvo.onion**, το οποίο είναι και η διεύθυνση του hidden service σου. Μπορείς άμεσα να δοκιμάσεις στον Tor browser την αντίστοιχη διεύθυνση και να επιβεβαιώσεις ότι λειτουργεί, καθώς θα μπορείς δεις τα αρχεία που υπάρχουν στο φάκελο /var/www/html του server σου.

![Hidden service example](/exercises/hidden/1.PNG)

## Παρατηρήσεις

1. Κατά την εγκατάσταση του server θα πρέπει να προσέξεις να μη σε συνδέει τίποτα με το μηχάνημα (π.χ. το όνομα DimitrisKarakostasPC **δεν** είναι καλή ιδέα για το όνομα του μηχανήματος, αλλά ούτε και για όνομα χρήστη). Αυτό ισχύει γιατί πληροφορίες για το μηχάνημα επιστρέφονται, τόσο κατά τη σύνδεση σε αυτό, όσο και σε περίπτωση μηνυμάτων σφάλματος.

2. Είναι κακή ιδέα να χρησιμοποιείς το ίδιο μηχάνημα ως hidden service και relay, καθώς υπάρχει κίνδυνος να αποκαλυφθεί η σύνδεση μεταξύ των δύο. Συγκεκριμένα, κάποιος επιτιθέμενος μπορεί να στείλει ένα συγκεκριμένο pattern κίνησης προς το hidden service και στη συνέχεια, παρατηρώντας την κίνηση στα relays, να βρει αν το service αυτό βρίσκεται στο ίδιο μηχάνημα με κάποιο από αυτά. Περισσότερα πάνω σε αυτό μπορείς να δεις [εδώ](https://trac.torproject.org/projects/tor/ticket/8742).